#!/bin/bash
# =================================
# Automated Production Setup Script
# =================================
# This script sets up the production environment on your Infuze server

set -e  # Exit on any error

echo "🚀 Starting production server setup..."

# Update system
echo "📦 Updating system packages..."
apt update && apt upgrade -y

# Install Node.js 18.x
echo "📥 Installing Node.js 18.x..."
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
apt-get install -y nodejs

# Install pnpm
echo "📥 Installing pnpm..."
npm install -g pnpm

# Install PM2 for process management
echo "📥 Installing PM2..."
npm install -g pm2

# Install Nginx
echo "📥 Installing Nginx..."
apt install -y nginx

# Configure firewall
echo "🔥 Configuring firewall..."
ufw allow 22   # SSH
ufw allow 80   # HTTP
ufw allow 443  # HTTPS
ufw allow 3000 # Next.js (temporary)
ufw --force enable

# Create application directory
echo "📁 Setting up application directory..."
mkdir -p /var/www/thebestnexusletters
chown -R $USER:$USER /var/www/thebestnexusletters

# Create environment file
echo "🔧 Creating environment configuration..."
cat > /var/www/thebestnexusletters/.env.production << 'EOF'
# =================================
# PRODUCTION ENVIRONMENT
# =================================
# Generated on: 2025-08-09T17:19:57.551Z
# Generated by: Production Environment Setup Script

# =================================
# APPLICATION CONFIGURATION
# =================================
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://thebestnexusletters.com
NEXT_TELEMETRY_DISABLED=1

# =================================
# DATABASE CONFIGURATION (SUPABASE)
# =================================
NEXT_PUBLIC_SUPABASE_URL=https://ipn1hdrvua4obw8x11wd.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvdXItcHJvamVjdC1yZWYiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc1NDc0ODEyNiwiZXhwIjoxNzg2Mjg0MTI2fQ.Es-XAnNYk5Hao4JPiFREgcfOClElNtNZDNAvwVvahGE
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvdXItcHJvamVjdC1yZWYiLCJyb2xlIjoic2VydmljZV9yb2xlIiwiaWF0IjoxNzU0NzQ4MTI2LCJleHAiOjE3ODYyODQxMjZ9.59EKO7JfFxMDIBVcEJxnUQPvWoQ7WxQlYBKVuOeXM8Y

# =================================
# APPLICATION SECURITY
# =================================
NEXTAUTH_SECRET=4Q4WnQJ74Px+ZMIvPesiQwFzi4Errq/SBMWMwl0pcuQ=
JWT_SECRET=qn5BMXkaeQ8QlkYG9UXM6nnXp/ac6i97j2kaQDSmlk0=
ENCRYPTION_KEY=3KLVNsjR/Khe5QwZENHK3A==

# =================================
# INFUZE.CLOUD DEPLOYMENT
# =================================
INFUZE_API_KEY=${INFUZE_API_KEY}
INFUZE_PROJECT_ID=the-best-nexus-letters
INFUZE_REGION=london-1
INFUZE_API_URL=https://api.infuze.cloud
INFUZE_ENVIRONMENT=production

# =================================
# EXTERNAL SERVICES
# =================================
DISCOURSE_SECRET=7NPy4QuXlLT0gpcxO2i4GtDJ3UNyEfmGHUYX2t6qo7M=
DISCOURSE_SSO_SECRET=tte7TyN8+f39ijKac1ILf2eUmdgbXE7yr0I9uhO9Y9M=
DISCOURSE_BASE_URL=localhost:1001

# =================================
# MONITORING & ANALYTICS
# =================================


EOF

# Configure Nginx
echo "🌐 Configuring Nginx..."
cat > /etc/nginx/sites-available/thebestnexusletters << 'EOF'
server {
    listen 80;
    server_name thebestnexusletters.com www.thebestnexusletters.com;
    
    # Redirect www to non-www
    if ($host = www.thebestnexusletters.com) {
        return 301 http://thebestnexusletters.com$request_uri;
    }
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Health check endpoint
    location /api/health {
        proxy_pass http://localhost:3000/api/health;
        access_log off;
    }
}
EOF

# Enable Nginx site
ln -sf /etc/nginx/sites-available/thebestnexusletters /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t && systemctl restart nginx

# Configure PM2 ecosystem
echo "⚙️  Configuring PM2 ecosystem..."
cat > /var/www/thebestnexusletters/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'thebestnexusletters',
    script: 'npm',
    args: 'start',
    cwd: '/var/www/thebestnexusletters',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/pm2/thebestnexusletters-error.log',
    out_file: '/var/log/pm2/thebestnexusletters-out.log',
    log_file: '/var/log/pm2/thebestnexusletters.log',
    max_restarts: 3,
    restart_delay: 5000
  }]
};
EOF

# Create PM2 log directory
mkdir -p /var/log/pm2

# Set up PM2 startup
pm2 startup systemd -u $USER --hp $HOME
pm2 save

echo "✅ Production server setup complete!"
echo ""
echo "🔧 Next steps:"
echo "1. Deploy your application code to /var/www/thebestnexusletters"
echo "2. Run: cd /var/www/thebestnexusletters && pnpm install && pnpm run build"
echo "3. Start with PM2: pm2 start ecosystem.config.js"
echo "4. Check status: pm2 status"
echo "5. View logs: pm2 logs thebestnexusletters"
echo ""
echo "🌐 Your application will be available at: http://$(curl -s ifconfig.me)"
